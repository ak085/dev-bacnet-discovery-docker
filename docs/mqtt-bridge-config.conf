# MQTT Bridge Configuration for Broker 10.0.60.2 (Local)
# ==========================================================
# This file should be deployed to LXC container running MQTT broker at 10.0.60.2
# Location: /etc/mosquitto/bridge.conf
#
# Purpose: Forward all BACnet topics from local broker (60.2) to remote broker (60.3)
# Architecture: BacPipes (edge) → Broker 60.2 → Bridge → Broker 60.3 → BacPipes-Remote (cloud)
#
# IMPORTANT: Mosquitto 2.0.22+ requires:
# - Explicit listener configuration in mosquitto.conf
# - Use 'include /etc/mosquitto/bridge.conf' directive in main config
# - NO leading spaces in configuration files (causes syntax errors)

# ==========================================================
# Bridge Configuration - Unsecured (Development)
# ==========================================================
# For production, enable TLS by uncommenting TLS section below

connection bridge-to-remote
    # Remote broker address
    address 10.0.60.3:1883

    # Bridge all site topics (klcc, menara, etc.)
    # Format: topic <pattern> <direction> <QoS> <local-prefix> <remote-prefix>
    # Direction: out = local→remote, in = remote→local, both = bidirectional
    topic klcc/# out 1
    topic menara/# out 1
    topic # out 0 "" remote/

    # Bridge settings
    cleansession false          # Persist session state across restarts
    try_private false           # Don't attempt private bridge mode
    notifications false         # Don't send notifications to $SYS/broker/connection
    start_type automatic        # Start bridge automatically on broker startup
    restart_timeout 30          # Retry connection every 30 seconds if disconnected

    # Client ID for bridge connection
    clientid bridge_local_to_remote

    # Keepalive
    keepalive_interval 60

    # Logging
    log_type all

# ==========================================================
# Bridge Configuration - Secured (Production - TLS)
# ==========================================================
# Uncomment and configure when ready for production deployment
#
# connection bridge-to-remote-secure
#     address 10.0.60.3:8883
#
#     # Topics (same as above)
#     topic klcc/# out 1
#     topic menara/# out 1
#     topic # out 0 "" remote/
#
#     # TLS Configuration
#     bridge_cafile /etc/mosquitto/certs/ca.crt
#     bridge_certfile /etc/mosquitto/certs/client.crt
#     bridge_keyfile /etc/mosquitto/certs/client.key
#     bridge_tls_version tlsv1.2
#     bridge_insecure false
#
#     # Bridge settings (same as unsecured)
#     cleansession false
#     try_private false
#     notifications false
#     start_type automatic
#     restart_timeout 30
#     clientid bridge_local_to_remote_tls
#     keepalive_interval 60
#     log_type all

# ==========================================================
# Deployment Instructions (Mosquitto 2.0.22+)
# ==========================================================
#
# STEP 1: Configure Main Mosquitto Config
# ========================================
# SSH to MQTT broker LXC (10.0.60.2):
#    ssh user@10.0.60.2
#
# Edit /etc/mosquitto/mosquitto.conf (ensure NO leading spaces):
#    sudo nano /etc/mosquitto/mosquitto.conf
#
# Minimal configuration:
# ----------------------
# # Mosquitto 2.0.22 Configuration
# # Allow remote connections
#
# # Listen on all interfaces, port 1883
# listener 1883 0.0.0.0
# allow_anonymous true
#
# # Persistence
# persistence true
# persistence_location /var/lib/mosquitto/
#
# # Logging
# log_dest file /var/log/mosquitto/mosquitto.log
# log_type all
#
# # Include bridge configuration
# include /etc/mosquitto/bridge.conf
# ----------------------
#
# STEP 2: Deploy Bridge Configuration
# ===================================
# Copy this file to /etc/mosquitto/bridge.conf:
#    sudo cp mqtt-bridge-config.conf /etc/mosquitto/bridge.conf
#
# Verify file ownership and permissions:
#    sudo chown mosquitto:mosquitto /etc/mosquitto/bridge.conf
#    sudo chmod 644 /etc/mosquitto/bridge.conf
#
# STEP 3: Verify Configuration Syntax
# ===================================
# IMPORTANT: Ensure NO leading spaces in config files!
# Check for syntax errors:
#    sudo mosquitto -c /etc/mosquitto/mosquitto.conf -v
#    (Press Ctrl+C after verifying no errors like "Unknown configuration variable")
#
# STEP 4: Restart Mosquitto Service
# =================================
#    sudo systemctl restart mosquitto
#    sudo systemctl status mosquitto
#    (Should show "active (running)")
#
# STEP 5: Verify Listening Port
# =============================
#    sudo ss -tulpn | grep 1883
#    (Should show: tcp LISTEN 0.0.0.0:1883)
#
# STEP 6: Check Bridge Status
# ===========================
#    sudo journalctl -u mosquitto -f
#    (Look for: "Connecting bridge bridge-to-remote (10.0.60.3:1883)")
#    (Should see: "Connection Accepted" or "Connected to 10.0.60.3")
#
# STEP 7: Test Bridge Forwarding
# ==============================
# On local broker (10.0.60.2), publish test message:
#    mosquitto_pub -h 10.0.60.2 -t "klcc/test" -m "hello from local"
#
# On remote broker (10.0.60.3), subscribe:
#    mosquitto_sub -h 10.0.60.3 -t "klcc/#" -v
#    (Should see: klcc/test hello from local)
#
# Also check bridged prefix topics:
#    mosquitto_sub -h 10.0.60.3 -t "remote/#" -v
#    (Should see: remote/klcc/test hello from local)
#
# ==========================================================
# Troubleshooting
# ==========================================================
#
# Issue: Mosquitto fails to start with "Unknown configuration variable" error
# - Symptom: Error: Unknown configuration variable "#"
# - Cause: Leading spaces before lines in config file
# - Fix: Edit config file and remove ALL leading spaces/tabs
#   sudo sed -i 's/^[[:space:]]//' /etc/mosquitto/mosquitto.conf
# - Verify: cat -A /etc/mosquitto/mosquitto.conf (should show NO spaces before lines)
#
# Issue: Mosquitto only listens on 127.0.0.1 (local only mode)
# - Symptom: ss -tulpn | grep 1883 shows 127.0.0.1:1883
# - Cause: Missing listener configuration in mosquitto.conf
# - Fix: Add "listener 1883 0.0.0.0" and "allow_anonymous true" to mosquitto.conf
# - Verify: ss -tulpn | grep 1883 should show 0.0.0.0:1883
#
# Issue: Mosquitto "include" directive not recognized
# - Symptom: Error: Unknown configuration variable "include"
# - Cause: Old Mosquitto version (< 2.0)
# - Fix: Upgrade to Mosquitto 2.0.22+
#   sudo apt update && sudo apt install mosquitto
#   mosquitto -v (should show version 2.0.22 or higher)
#
# Issue: Bridge not connecting to remote broker
# - Check remote broker is running: telnet 10.0.60.3 1883
# - Check firewall allows outbound 1883: sudo iptables -L -n
# - Check logs: sudo journalctl -u mosquitto -f | grep bridge
# - Verify remote broker allows external connections (listener 1883 0.0.0.0)
#
# Issue: Topics not forwarding
# - Verify topic pattern matches published topics
# - Check QoS levels (0 = at most once, 1 = at least once, 2 = exactly once)
# - Test publish locally: mosquitto_pub -h 10.0.60.2 -t "klcc/test" -m "hello"
# - Subscribe remotely: mosquitto_sub -h 10.0.60.3 -t "klcc/#" -v
#
# Issue: Duplicate messages on remote broker
# - Ensure cleansession is false
# - Check bridge clientid is unique
# - Verify only one bridge connection exists:
#   sudo journalctl -u mosquitto | grep "bridge-to-remote" | tail -20
#
# Issue: BacPipes worker cannot connect to broker
# - Verify broker is listening: sudo ss -tulpn | grep 1883
# - Test from BacPipes host: mosquitto_sub -h 10.0.60.2 -t "test" -v
# - Check worker logs: docker compose logs bacnet-worker
# - Verify MQTT_BROKER environment variable is correct
#
# ==========================================================
