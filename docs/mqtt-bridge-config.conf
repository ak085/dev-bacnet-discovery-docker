# MQTT Bridge Configuration for Broker 10.0.60.2 (Local)
# ==========================================================
# This file should be deployed to LXC container running MQTT broker at 10.0.60.2
# Location: /etc/mosquitto/conf.d/bridge.conf
#
# Purpose: Forward all BACnet topics from local broker (60.2) to remote broker (60.3)
# Architecture: BacPipes (edge) → Broker 60.2 → Bridge → Broker 60.3 → BacPipes-Remote (cloud)

# ==========================================================
# Bridge Configuration - Unsecured (Development)
# ==========================================================
# For production, enable TLS by uncommenting TLS section below

connection bridge-to-remote
    # Remote broker address
    address 10.0.60.3:1883

    # Bridge all site topics (klcc, menara, etc.)
    # Format: topic <pattern> <direction> <QoS> <local-prefix> <remote-prefix>
    # Direction: out = local→remote, in = remote→local, both = bidirectional
    topic klcc/# out 1
    topic menara/# out 1
    topic # out 0 "" remote/

    # Bridge settings
    cleansession false          # Persist session state across restarts
    try_private false           # Don't attempt private bridge mode
    notifications false         # Don't send notifications to $SYS/broker/connection
    start_type automatic        # Start bridge automatically on broker startup
    restart_timeout 30          # Retry connection every 30 seconds if disconnected

    # Client ID for bridge connection
    clientid bridge_local_to_remote

    # Keepalive
    keepalive_interval 60

    # Logging
    log_type all

# ==========================================================
# Bridge Configuration - Secured (Production - TLS)
# ==========================================================
# Uncomment and configure when ready for production deployment
#
# connection bridge-to-remote-secure
#     address 10.0.60.3:8883
#
#     # Topics (same as above)
#     topic klcc/# out 1
#     topic menara/# out 1
#     topic # out 0 "" remote/
#
#     # TLS Configuration
#     bridge_cafile /etc/mosquitto/certs/ca.crt
#     bridge_certfile /etc/mosquitto/certs/client.crt
#     bridge_keyfile /etc/mosquitto/certs/client.key
#     bridge_tls_version tlsv1.2
#     bridge_insecure false
#
#     # Bridge settings (same as unsecured)
#     cleansession false
#     try_private false
#     notifications false
#     start_type automatic
#     restart_timeout 30
#     clientid bridge_local_to_remote_tls
#     keepalive_interval 60
#     log_type all

# ==========================================================
# Deployment Instructions
# ==========================================================
#
# 1. SSH to MQTT broker LXC (10.0.60.2):
#    ssh user@10.0.60.2
#
# 2. Copy this file to Mosquitto config directory:
#    sudo cp bridge.conf /etc/mosquitto/conf.d/bridge.conf
#
# 3. Verify Mosquitto can read the file:
#    sudo chown mosquitto:mosquitto /etc/mosquitto/conf.d/bridge.conf
#    sudo chmod 644 /etc/mosquitto/conf.d/bridge.conf
#
# 4. Test configuration syntax:
#    mosquitto -c /etc/mosquitto/mosquitto.conf -v
#    (Press Ctrl+C after verifying no errors)
#
# 5. Restart Mosquitto service:
#    sudo systemctl restart mosquitto
#
# 6. Check bridge status in logs:
#    sudo journalctl -u mosquitto -f
#    (Look for: "Connecting bridge bridge-to-remote (10.0.60.3:1883)")
#
# 7. Test bridge from remote broker (10.0.60.3):
#    mosquitto_sub -h 10.0.60.3 -t "klcc/#" -v
#    (Should see messages forwarded from broker 60.2)
#
# ==========================================================
# Troubleshooting
# ==========================================================
#
# Issue: Bridge not connecting
# - Check remote broker is running: telnet 10.0.60.3 1883
# - Check firewall allows outbound 1883: sudo iptables -L -n
# - Check logs: sudo journalctl -u mosquitto --since "5 min ago"
#
# Issue: Topics not forwarding
# - Verify topic pattern matches published topics
# - Check QoS levels (0 = at most once, 1 = at least once, 2 = exactly once)
# - Test publish locally: mosquitto_pub -h 10.0.60.2 -t "klcc/test" -m "hello"
#
# Issue: Duplicate messages
# - Ensure cleansession is false
# - Check bridge clientid is unique
# - Verify only one bridge connection exists
#
# ==========================================================
