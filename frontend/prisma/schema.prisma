// BacPipes - Prisma Schema
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Devices
// ============================================

model Device {
  id              Int       @id @default(autoincrement())
  deviceId        Int       @unique  // BACnet device ID (e.g., 221, 2020521)
  deviceName      String              // e.g., "Excelsior", "POS466.65/100"
  ipAddress       String              // e.g., "192.168.1.37"
  port            Int       @default(47808)
  vendorId        Int?                // BACnet vendor ID
  vendorName      String?             // e.g., "Siemens"
  description     String?
  enabled         Boolean   @default(true)

  // Relationships
  points          Point[]

  // Timestamps
  discoveredAt    DateTime  @default(now())
  lastSeenAt      DateTime  @updatedAt

  @@index([deviceId])
  @@index([enabled])
}

// ============================================
// Points (BACnet Objects)
// ============================================

model Point {
  id                    Int       @id @default(autoincrement())

  // BACnet identification
  deviceId              Int
  device                Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  objectType            String    // e.g., "analog-input", "analog-output", "binary-input"
  objectInstance        Int       // BACnet object instance number
  pointName             String    // BACnet object name
  description           String?
  units                 String?   // Engineering units (e.g., "degreesCelsius", "percent")

  // Haystack tagging (for MQTT topic generation and point naming)
  siteId                String?   // e.g., "klcc", "menara"
  equipmentType         String?   // e.g., "ahu", "vav", "chiller"
  equipmentId           String?   // e.g., "12", "north_wing_01"
  pointFunction         String?   // e.g., "sp", "cmd", "sensor"
  quantity              String?   // e.g., "temp", "speed", "pos", "pressure"
  subject               String?   // e.g., "air", "water", "chilled-water"
  location              String?   // e.g., "supply", "return", "coil"
  qualifier             String?   // e.g., "effective", "min", "max", "enable"
  haystackPointName     String?   // Auto-generated: {site}.{equip_type}.{equip_id}.{func}.{qty}.{subj}.{loc}.{qual}
  dis                   String?   // Human-readable display name

  // MQTT configuration
  enabled               Boolean   @default(true)   // Point enabled for discovery display
  mqttPublish           Boolean   @default(false)  // Publish to MQTT broker
  mqttTopic             String?   // Auto-generated from Haystack tags
  pollInterval          Int       @default(60)     // Polling interval in seconds
  qos                   Int       @default(1)      // MQTT QoS (0, 1, 2)

  // Access control (from discovery/analysis)
  isReadable            Boolean   @default(true)
  isWritable            Boolean   @default(false)
  priorityArray         Boolean   @default(false)  // Has priority array (16 levels)
  priorityLevel         Int?      // Default priority for writes (1-16)

  // Operational metadata
  lastValue             String?   // Last polled value (for quick dashboard display)
  lastPollTime          DateTime? // When last successfully polled
  errorCount            Int       @default(0)      // Consecutive error count
  lastError             String?   // Last error message

  // Relationships
  writeHistory          WriteHistory[]

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([deviceId, objectType, objectInstance])
  @@index([deviceId])
  @@index([enabled])
  @@index([mqttPublish])
  @@index([siteId, equipmentType, equipmentId])
}

// ============================================
// MQTT Configuration
// ============================================

model MqttConfig {
  id                Int       @id @default(autoincrement())

  // Connection
  broker            String    @default("10.0.60.50")
  port              Int       @default(1883)
  clientId          String    @default("bacpipes_worker")
  username          String?
  password          String?
  keepAlive         Int       @default(30)      // Seconds

  // Topics
  writeCommandTopic String    @default("bacnet/write/command")
  writeResultTopic  String    @default("bacnet/write/result")

  // Publishing Options
  enableBatchPublishing Boolean @default(false)  // Publish equipment-level batch topics (for ML/AI)

  // Status
  enabled           Boolean   @default(true)

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ============================================
// InfluxDB Configuration
// ============================================

model InfluxConfig {
  id                Int       @id @default(autoincrement())

  // Connection
  host              String    @default("10.0.60.5")
  port              Int       @default(8086)
  organization      String?   @default("bacnet")
  bucket            String?   @default("bacnet_data")
  token             String?

  // Retention
  retentionDays     Int       @default(30)

  // Status
  enabled           Boolean   @default(false)  // Optional feature

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ============================================
// Write Command History
// ============================================

model WriteHistory {
  id                Int       @id @default(autoincrement())
  jobId             String    @unique  // UUID for tracking write command

  // Target point
  pointId           Int
  point             Point     @relation(fields: [pointId], references: [id], onDelete: Cascade)

  // Write command
  value             String?   // Value written (null if releasing priority)
  priority          Int       // Priority level (1-16)
  release           Boolean   @default(false)  // True if releasing priority

  // Result
  success           Boolean
  errorMessage      String?

  // Timestamp
  timestamp         DateTime  @default(now())

  @@index([pointId])
  @@index([timestamp])
  @@index([success])
}

// ============================================
// Error Log
// ============================================

model ErrorLog {
  id                Int       @id @default(autoincrement())

  // Context
  pointId           Int?      // Optional: related point
  source            String?   // e.g., "worker", "discovery", "api"
  message           String
  stackTrace        String?

  // Timestamp
  timestamp         DateTime  @default(now())

  @@index([pointId])
  @@index([timestamp])
  @@index([source])
}

// ============================================
// Discovery Job Tracking (Optional for M2)
// ============================================

model DiscoveryJob {
  id                String    @id @default(uuid())

  // Configuration
  ipAddress         String
  port              Int       @default(47808)
  timeout           Int       @default(15)      // Seconds
  deviceId          Int       @default(3001234) // Scanner device ID

  // Status
  status            String    // "running", "complete", "error", "cancelled"

  // Results
  devicesFound      Int       @default(0)
  pointsFound       Int       @default(0)
  errorMessage      String?

  // Timestamps
  startedAt         DateTime  @default(now())
  completedAt       DateTime?

  @@index([status])
  @@index([startedAt])
}

// ============================================
// System Settings
// ============================================

model SystemSettings {
  id                    Int       @id @default(autoincrement())

  // Network
  bacnetIp              String    @default("192.168.1.35")
  bacnetPort            Int       @default(47808)
  bacnetDeviceId        Int       @default(3001234)
  discoveryTimeout      Int       @default(15)      // Seconds

  // System
  timezone              String    @default("Asia/Kuala_Lumpur")
  defaultPollInterval   Int       @default(60)      // Seconds
  configRefreshInterval Int       @default(60)      // Seconds
  dashboardRefresh      Int       @default(10)      // Seconds
  logRetentionDays      Int       @default(30)

  // Timestamps
  updatedAt             DateTime  @updatedAt
}
